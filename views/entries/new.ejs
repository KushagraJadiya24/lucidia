<% layout('layouts/boilerplate') %>

<div class="container new_entry mt-5">
  <div class="new-entry-header text-center mb-5 animate-entry">
    <h1 class="display-5 fw-bold gradient-heading">“Dear Diary, Today I…”</h1>
  </div>
  <button id="ai-suggest-btn" class="btn btn-outline-light">
    <span id="btn-text">Get AI Suggestion</span>
    <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
  </button>

 <form id="entry-form" action="/entries" method="POST">
  <div class="mb-3">
    <label for="title" class="form-label">Title</label>
    <input type="text" class="form-control" id="title" name="title" required />
  </div>

  <div class="mb-3">
    <label class="form-label">Content</label>
    <div id="editor" style="height: 300px;"></div>

    <!-- Hidden field to store HTML from Quill -->
    <textarea id="content" name="content" hidden></textarea>
  </div>
  <div id="ai-suggestion-container" class="mt-4 d-none">
    <h5 class="text-light">✍️ AI Suggestion</h5>
    <div id="ai-suggestion" class="p-3 rounded text-light" style="background-color: #2c2c2c;"></div>
  </div>
  <button type="submit" class="btn btn-primary">Create Entry</button>
</form>


<script>
  const quill = new Quill('#editor', {
    theme: 'snow'
  });

   const form = document.getElementById('entry-form');
  const contentInput = document.getElementById('content');

  form.addEventListener('submit', function (e) {
    contentInput.value = quill.root.innerHTML;
  });

const btn = document.getElementById("ai-suggest-btn");
  const text = document.getElementById("btn-text");
  const spinner = document.getElementById("spinner");
  const suggestionContainer = document.getElementById("ai-suggestion-container");
  const suggestionDiv = document.getElementById("ai-suggestion");

  btn.addEventListener("click", async (e) => {
    e.preventDefault();

    // Start loading
    btn.disabled = true;
    spinner.classList.remove("d-none");
    text.innerText = "Thinking...";

    // Get the prompt from Quill
    const prompt = quill.getText(); // or quill.root.innerText

    try {
      const res = await fetch("/ai/suggest", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });

      const data = await res.json();

      if (data && data.suggestion) {
        suggestionContainer.classList.remove("d-none");
        suggestionDiv.innerText = data.suggestion.trim();
      } else {
        suggestionDiv.innerText = "No suggestion received.";
      }
    } catch (err) {
      suggestionDiv.innerText = "Error fetching suggestion.";
      suggestionContainer.classList.remove("d-none");
    } finally {
      // Reset UI
      btn.disabled = false;
      spinner.classList.add("d-none");
      text.innerText = "Get AI Suggestion";
    }
  });
</script>
</div>
